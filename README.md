# TJUT-RM-Firmware

## 概述

### 最新变动

- 添加了对VS2017的编译和调试支持，即现在可以使用VS进行调试。解决方案文件在（../VS2017）目录下
- 更改了一个结构体名的冲突： 原变量名 ~~pid_t~~ 更改为 pidc_t
- 为添加对GCC编译器的支持，部分头文件增加了宏定义；对于GCC编译器 ~~__packed struct~~ 更改为 struct __packed

### 软件环境

For MDK-ARM：

- Toolchain/IDE: MDK-ARM V5
- Package version: STM32Cube FW_F4 V1.19.0
- FreeRTOS version: 9.0.0 (portable:RVDS)
- CMSIS-RTOS version: 1.02

For Visual Studio：

- Toolchain/IDE: Visual Studio 2017 & VisualGDB V5.3
- VisualGDB Toochains:  ARM toochains (GCC 9.2.1; GDB 8.3.0)
- VisualGDB Embedded BSPs: STM32 Devices (2019.06)
- Package version: STM32Cube FW_F4 V1.19.0
- FreeRTOS version: 9.0.0 (portable:GCC)
- CMSIS-RTOS version: 1.02

### 编程规范

- 常量用全大写命名，多个单词之间用下划线链接
- 变量采用驼峰法命名方式
- 函数采用组合式命名（现仍在修改部分命名）
- chassis\_task、gimbal\_task和shoot\_task是强实时控制任务，优先级最高，禁止被其他任务抢占或者阻塞
- 其余任务以正常优先级进行工作

### 注意事项

1.由于云台电机（YAW和PIT轴）受机械安装位置影响，无法**避免机械零点**。需要在首次上电后，将云台转至零点位置，记下当前电机角度，并填入**USER_DEFINATION.h**里面。否则云台上电后将转至未知角度。

### 开发板指示灯说明

- 红灯常亮：表示未进入线程
- 绿灯常亮：已进入线程，且正常运行（此时红灯熄灭，否则为异常）
- 左边8颗绿灯
  - 常亮：所有模块正常
  - 有熄灭的：部分模块初始化异常

## 快速开始

### 硬件接口

主控板使用 RM 开发板 A 型，各个功能接口的位置如下：

**接口图片**

### 功能模块

#### 测试模式

提供遥控器基础控制。

#### 比赛模式

这种模式下底盘、云台、发射机构受到键盘和鼠标的完全控制，在比赛的时候开启。

#### 操作档位说明

##### 测试档

| 底盘 | 云台 | 发射机构 | 左拨杆 | 右拨杆 |
| ---- | ---- | -------- | ------ | ------ |
| 释放 | 释放 | 无动作   | 上     | 上     |
| 锁死 | 锁死 | 无动作   | 中     | 上     |
| 可控 | 锁死 | 无动作   | 下     | 上     |
| 锁死 | 可控 | 无动作   | 上     | 中     |
| 锁死 | 可控 | 无动作   | 中     | 中     |
| 可控 | 可控 | 无动作   | 下     | 中     |
| 锁死 | 可控 | 发射     | 上     | 下     |
| 锁死 | 可控 | 发射     | 中     | 下     |
| 键鼠 | 键鼠 | 键鼠     | 下     | 下     |

##### 比赛档

正常比赛时使用（拨杆全下）

按键位置对应功能：

- W/A/S/D：车的前后左右平移
- Q/E：向左或向右偏头，此时前进方向以摄像头向前的位置
- R：弹仓盖开
- G：弹仓盖关
- F：摩擦轮开
- B：摩擦轮关
- SHIFT: 两倍速度（按住）
- CTRL:  半倍速度（按住）

## 程序说明

### 程序体系结构

#### 体系框架

1. 使用免费及开源的 freertos 操作系统，兼容其他开源协议 license；
2. 使用标准 CMSIS-RTOS 接口，方便不同操作系统或平台间程序移植；
3. 提供一套抽象步兵机器人bsp，简化上层逻辑；

**图片**

**Device**：直接操作底层硬件的设备驱动，由CubeMX建立。

**System**：是用于存放作用于整个系统的函数

**Bsp**：具有一种或者多种总线输入，一种或者多种数据输出的外部模块。主要用于处理与开发板相关的通讯。目前主要针对RM物资的驱动抽象成设备。

**Algorithm**：提供模块算法，基本文件间无相互依赖。

**Fuction**：可以实现某种特殊功能的模块。比如oled的显示和裁判系统的数据处理。

**Task**：上层应用逻辑，包括所有任务函数；

### 软件体系

### 硬件体系

1. 主控 MCU：STM32F427IIHx，配置运行频率180MHz
2. 模块通信方式：CAN，UART；

- CAN1：电机电调
- UART1：DBus（100000波特率）
- UART3：裁判系统（115200波特率、8数据位、1停止位）
- UART6：PC通讯（115200波特率、8数据位、1停止位）
- SPI1：OLED屏
- SPI5：MPU6600

1. 麦轮安装方式：X型

### 协议数据

#### 数据分类

协议数据按照通信方向可以分为两大类：

底层发送给上层的数据：

1. 反馈信息：包含各个机构传感器反馈信息、底层计算出来的一些反馈信息；
2. 底层状态信息：包含底层设备运行状态、底层对上层数据的一些响应等；
3. 转发数据：包含裁判系统的全部信息、服务器端的自定义信息；

底层接收的上层数据：

1. 控制信息：上层对底层 3 个执行机构的控制信息；